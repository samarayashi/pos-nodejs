<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/4.3.0/jquery.form.min.js"
        integrity="sha384-qlmct0AOBiA2VPZkMY3+2WqkHtIQ9lSdAsAn5RUJD/3vA5MKDgSGcdmIv4ycVxyn"
        crossorigin="anonymous"></script>
    <style>
        body,
        html {
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            font-family: "Comic Sans MS", "Microsoft JhengHei";
            color: #333;
        }

        #outer_container {
            display: flex;
            height: 100%;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
        }

        #order_area_container {
            flex: 1 0 500px;
        }

        #detail_area_container {
            flex: 1 1 500px;
            background-color: #EAF0ED;
        }

        #check_area_container {
            flex: 1 0 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            overflow-y: scroll;
            /* overflow-y: overlay; */
            /* overflow-y: auto; */
        }

        .order_table {
            border-collapse: collapse;
            border: 1px solid black;

        }

        .order_table tr {
            border: 1px solid #000;
            padding: 15px;
        }

        .detail_table td {
            padding-right: 5px;
        }

        .check_table {
            border: 1px solid black;
            border-collapse: collapse;
            margin: 10px;
            padding: 5px;
        }

        .check_table tr {
            border: 1px dashed black;
        }

        .checked_table {
            background-color: gray;
        }

        .button {
            border: none;
            color: black;
            background-color: white;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-top: 16px;
            margin-bottom: 8px;
            border: 2px solid black;
        }
    </style>
</head>

<body>
    <div id="outer_container">
        <div id="order_area_container">
            <div>當前時間</div>
            <div id="datebox"></div>
            <div id="timebox"></div><br>
            <!-- <form id="order_form" action="send_order" method="POST"> -->
            <form id="order_form" action="" method="GET">
                <label>單號: <input id="sheet_number" name='sheet_number' type="text" value="1" readonly></label>
                <table class="order_table">
                    <tr>
                        <td>
                            裹粉熱狗:
                        </td>
                        <td>
                            <input type="radio" id='first_normal_hot_dog' name="normal_hot_dog" value="0" checked>0
                            <input type="radio" name="normal_hot_dog" value="1">1
                            <input type="radio" name="normal_hot_dog" value="2">2
                            <input type="radio" name="normal_hot_dog" value="3">3
                            <input type="radio" name="normal_hot_dog" value="4">4
                            <input type="radio" name="normal_hot_dog" value="5">5
                            <input type="radio" name="normal_hot_dog" value="6">6
                            <input type="radio" name="normal_hot_dog" value="7">7
                            <input type="radio" name="normal_hot_dog" value="8">8
                            <input type="radio" name="normal_hot_dog" value="9">9
                            </p>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            熱狗堡:
                        </td>
                        <td>
                            <input type="radio" id='first_hot_dog_fort' name="hot_dog_fort" value="0" checked>0
                            <input type="radio" name="hot_dog_fort" value="1">1
                            <input type="radio" name="hot_dog_fort" value="2">2
                            <input type="radio" name="hot_dog_fort" value="3">3
                            <input type="radio" name="hot_dog_fort" value="4">4
                            <input type="radio" name="hot_dog_fort" value="5">5
                            <input type="radio" name="hot_dog_fort" value="6">6
                            <input type="radio" name="hot_dog_fort" value="7">7
                            <input type="radio" name="hot_dog_fort" value="8">8
                            <input type="radio" name="hot_dog_fort" value="9">9
                        </td>
                    </tr>
                    <tr>
                        <td>
                            薯條熱狗:
                        </td>
                        <td>
                            <input type="radio" id="first_french_fries_dog" name="french_fries_dog" value="0" checked>0
                            <input type="radio" name="french_fries_dog" value="1">1
                            <input type="radio" name="french_fries_dog" value="2">2
                            <input type="radio" name="french_fries_dog" value="3">3
                            <input type="radio" name="french_fries_dog" value="4">4
                            <input type="radio" name="french_fries_dog" value="5">5
                            <input type="radio" name="french_fries_dog" value="6">6
                            <input type="radio" name="french_fries_dog" value="7">7
                            <input type="radio" name="french_fries_dog" value="8">8
                            <input type="radio" name="french_fries_dog" value="9">9
                        </td>
                    </tr>
                </table>
                <div>總金額：<span id="price_show"></span>
                </div>
                <div><input id="order_submit" type="submit" name="order_submit" value="確認訂單"></div>
            </form>
            <div style="margin-top: 100px;">
                <button id="restore_button" class="button">還原未完訂單</button>
                <button id='clean_storage_button' class="button">清空storage</button>
            </div>
        </div>
        <div id="detail_area_container">
            <div>訂單詳細內容</div><br>
            <div id="detail_table_area">
                <table class="detail_table" id="sheet_00">
                    <tr>
                        <td>單號: 00</td>
                    </tr>
                    <tr>
                        <td>果粉熱狗:</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>熱狗堡:</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>薯條熱狗:</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>金額:00</td>
                    </tr>
                </table>
                <button class="button">確認結帳</button>
                <button class="button" style="margin-left: 100px;">取消訂單</button>
            </div>

        </div>
        <div id="check_area_container">
            <div>查詢單號</div>
            <div>手頭總單數：</div>
            <table class="check_table">
                <tr>
                    <td>單號</td>
                    <td>00</td>
                </tr>
                <tr>
                    <td>金額</td>
                    <td>00</td>
                </tr>
            </table>
        </div>
    </div>



</body>
<script>
    var storage = localStorage;
    var sheet_number = 1
    var total_price = 0
    var show_order_sheet
    var show_order_price

    function ShowTime() {
        var NowDate = new Date();
        var year = NowDate.getFullYear();
        var month = NowDate.getMonth();
        var day = NowDate.getDate();
        var hour = NowDate.getHours();
        var minute = NowDate.getMinutes();
        var sec = NowDate.getSeconds();
        document.getElementById('datebox').innerHTML = year + '年' + month + '月' + day + '日';
        document.getElementById('timebox').innerHTML = hour + '時' + minute + '分' + sec + '秒';
        setTimeout('ShowTime()', 1000);
    }

    function get_total_price() {
        var purchase_items = $(':checked')
        var price_dict = {
            hot_dog_fort_price: 10,
            normal_hot_dog_price: 20,
            french_fries_dog_price: 30,
        }

        total_price = 0
        for (var item of purchase_items) {
            total_price += item.value * price_dict[item.name + '_price']
        }
        $("#price_show").text(total_price)
    }

    function update_serial_number() {
        sheet_number = sheet_number + 1;
        $('#sheet_number').val(sheet_number);
    }

    function add_check_table() {
        var template = `<table id="sheet_${sheet_number}" class="check_table">
                <tr>
                    <td>單號</td>
                    <td>${sheet_number}</td>
                </tr>
                <tr>
                    <td>金額</td>
                    <td>${total_price}</td>
                </tr>
            </table>`
        $("#check_area_container").append(template);

    }

    function get_order_detail() {
        var show = $(this).find('td:odd');
        show_order_sheet = show[0].innerHTML;
        show_order_price = show[1].innerHTML;
    }

    function show_order_detail() {
        var order_detail = JSON.parse(storage['sheet' + show_order_sheet]);
        var template = `<table id="show_${show_order_sheet}" class="detail_table">
                    <tr>
                        <td>單號:${show_order_sheet}</td>
                    </tr>
                    <tr>
                        <td>果粉熱狗:${order_detail.normal_hot_dog}</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>熱狗堡:${order_detail.hot_dog_fort}</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>薯條熱狗:${order_detail.french_fries_dog}</td>
                        <td>番茄:0</td>
                        <td>芥末:0</td>
                        <td>海苔:0</td>
                    </tr>
                    <tr>
                        <td>金額:${show_order_price}</td>
                    </tr>
                </table>
                <button class="button">確認結帳</button>
                <button class="button">取消訂單</button>`
        $('#detail_table_area').empty()
            .prepend(template);
    }

    function reset_form() {
        $("#first_hot_dog_fort").prop("checked", true);
        $("#first_normal_hot_dog").prop("checked", true);
        $("#first_french_fries_dog").prop("checked", true);
        $("#price_show").text(0);
        total_price = 0;
    }

    function set_sheet_storage() {
        var purchase_items = $(':checked')
        var data = {
            sheet_number,
            total_price
        }
        for (var item of purchase_items) {
            data[item.name] = item.value
        }
        storage['sheet' + sheet_number] = JSON.stringify(data)
    }

    function finish_payment() {
        $('#detail_area_container').on('click', '.button', function () {
            $('#detail_table_area').empty();
            $('#sheet_' + show_order_sheet).remove();
            delete storage['sheet' + show_order_sheet];
            // document.location.href = "localhost:5438/payment?sheet_number=1"
        })
    }

    function restore_unfinish_order() {
        $('#check_area_container>table').remove();
        var max_sheet_number = 0
        for (var i = 0; i < storage.length; i++) {
            var k = storage.key(i);
            if (!(k.startsWith('sheet'))) { continue; }
            var v = JSON.parse(storage[k]);
            let restore_sheet_number = v.sheet_number;
            var restore_total_price = v.total_price;
            if (restore_sheet_number > max_sheet_number) max_sheet_number = restore_sheet_number;
            var template = `<table id="sheet_${restore_sheet_number}" class="check_table">
                <tr>
                    <td>單號</td>
                    <td>${restore_sheet_number}</td>
                </tr>
                <tr>
                    <td>金額</td>
                    <td>${restore_total_price}</td>
                </tr>
            </table>`
            $("#check_area_container").append(template);
        }
        sheet_number = max_sheet_number + 1
        $('#sheet_number').val(sheet_number);



    }

    function clean_storage() {
        for (const key in storage) {
            if (storage.hasOwnProperty(key) && (key.startsWith('sheet'))) {
                storage.removeItem(key);
            }
        }
    }

    function mount_ajaxForm() {
        $('#order_form').ajaxForm(function () {
            add_check_table()
            set_sheet_storage()
            update_serial_number()
            reset_form()
        });
    }

    $(function () {
        $('#check_area_container').css('height', window.innerHeight * 0.9)
        $('table input').on('click', get_total_price)
        $('#check_area_container').on('click', '.check_table', function () {
            $(this).addClass('checked_table');
            $(this).siblings('.check_table').removeClass('checked_table')
        })
        // 讓detail_area帶有check_area的狀態
        $('#check_area_container').on('click', '.check_table', function () {
            get_order_detail.call(this);
            show_order_detail();
        })
        $('#restore_button').on('click', restore_unfinish_order)
        $('#clean_storage_button').on('click', clean_storage)

        ShowTime()
        mount_ajaxForm()
        finish_payment()
    })
</script>

</html>